name: Auto Code Converter & Organizer
on:
  push:
    branches: [ "main" ]
permissions:
  contents: write

jobs:
  organize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      # 1. ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œ íŒŒì¼ ê°ì§€ ë° ë§ˆí¬ë‹¤ìš´ ë³€í™˜ (ë°±ì¤€, í”„ë¡œê·¸ë˜ë¨¸ìŠ¤, ë¦¬íŠ¸ì½”ë“œ ëª¨ë‘ ì ìš©)
      - name: Convert Code to Markdown
        run: |
          echo "ğŸ› ï¸ ì†ŒìŠ¤ ì½”ë“œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì‘ì—… ì‹œì‘..."
          
          # ì´ë²ˆ ì»¤ë°‹ì—ì„œ ì¶”ê°€/ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          # (ì‚­ì œëœ íŒŒì¼ì€ ì œì™¸í•˜ê¸° ìœ„í•´ --diff-filter=d ì‚¬ìš©)
          git diff --name-only --diff-filter=d HEAD~1 HEAD > changed_files.txt

          while IFS= read -r file; do
            # íŒŒì¼ì´ ì¡´ì¬í•˜ê³ , ë””ë ‰í† ë¦¬ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ì²˜ë¦¬
            if [ -f "$file" ]; then
              # í™•ì¥ì ì¶”ì¶œ
              EXT="${file##*.}"
              LANG=""

              # ì–¸ì–´ë³„ ì½”ë“œë¸”ëŸ­ ë§¤í•‘
              case "$EXT" in
                py) LANG="python" ;;
                java) LANG="java" ;;
                cpp|cc|cxx) LANG="cpp" ;;
                js|ts) LANG="javascript" ;;
                go) LANG="go" ;;
                c) LANG="c" ;;
                kt|kotlin) LANG="kotlin" ;;
                swift) LANG="swift" ;;
                rb) LANG="ruby" ;;
                rs) LANG="rust" ;;
                sql) LANG="sql" ;;
                cs) LANG="csharp" ;;
              esac

              # ì§€ì›í•˜ëŠ” ì–¸ì–´ íŒŒì¼ì¸ ê²½ìš° ë³€í™˜ ìˆ˜í–‰ (ì´ë¯¸ .mdì¸ íŒŒì¼ì€ ê±´ë„ˆëœ€)
              if [ -n "$LANG" ]; then
                NEW_FILE="${file%.*}.md"
                echo "ğŸ“„ ë³€í™˜ ì¤‘: $file -> $NEW_FILE ($LANG)"
                
                # ì„ì‹œ íŒŒì¼ ìƒì„±
                TEMP_CONTENT=$(mktemp)
                
                # ë§ˆí¬ë‹¤ìš´ í—¤ë” ë° ì½”ë“œë¸”ëŸ­ ì‘ì„±
                echo "### ì†ŒìŠ¤ ì½”ë“œ ($file)" > "$TEMP_CONTENT"
                echo "" >> "$TEMP_CONTENT"
                echo "\`\`\`$LANG" >> "$TEMP_CONTENT"
                cat "$file" >> "$TEMP_CONTENT"
                echo "" >> "$TEMP_CONTENT"
                echo "\`\`\`" >> "$TEMP_CONTENT"
                
                # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë° ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì´ë™
                rm "$file"
                mv "$TEMP_CONTENT" "$NEW_FILE"
              fi
            fi
          done < changed_files.txt
          rm changed_files.txt
          echo "âœ… ë³€í™˜ ì™„ë£Œ"

      # 2. ë£¨íŠ¸ ê²½ë¡œì— ìˆëŠ” í´ë”(ë¦¬íŠ¸ì½”ë“œ ë¬¸ì œ)ë¥¼ ì •ë¦¬ (ë°±ì¤€/í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ í´ë”ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
      - name: Organize LeetCode Directories
        run: |
          ROOT_DIR="LeetCode"
          # ì •ë¦¬ì—ì„œ ì œì™¸í•  í´ë” ëª©ë¡ (ë°±ì¤€, í”„ë¡œê·¸ë˜ë¨¸ìŠ¤, ì„¤ì • í´ë” ë“±)
          EXCLUDE_DIRS=("LeetCode" "ë°±ì¤€" "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤" ".github" ".git" ".obsidian")
          
          # í˜„ì¬ ë£¨íŠ¸ì— ìˆëŠ” ë””ë ‰í† ë¦¬ë“¤ í™•ì¸
          for dir in */; do
            dir=${dir%/} # ìŠ¬ë˜ì‹œ ì œê±°
            
            # ì œì™¸í•  í´ë”ì¸ì§€ í™•ì¸
            SKIP=false
            for EX in "${EXCLUDE_DIRS[@]}"; do
              if [[ "$dir" == "$EX" ]]; then
                SKIP=true
                break
              fi
            done
            
            # ì •ë¦¬ ëŒ€ìƒ í´ë”(ë¦¬íŠ¸ì½”ë“œ ë¬¸ì œ)ë¼ë©´ ì´ë™ ë¡œì§ ìˆ˜í–‰
            if [[ "$SKIP" == false && -d "$dir" ]]; then
              echo "ğŸ“¦ ë¦¬íŠ¸ì½”ë“œ ë¬¸ì œ íŒ¨í‚¤ì§€ ê°ì§€: $dir"
              
              README_PATH="$dir/README.md"
              LEVEL="Unknown"
              
              # ë‚œì´ë„ ì¶”ì¶œ
              if [ -f "$README_PATH" ]; then
                LEVEL=$(grep -oP '(?<=<h3>).*?(?=</h3>)' "$README_PATH" | head -n 1)
                if [ -z "$LEVEL" ]; then LEVEL="Unknown"; fi
              fi
              echo "   - ë‚œì´ë„: $LEVEL"
              
              # ì´ë™í•  ëª©ì ì§€ ì„¤ì •
              TARGET_DIR="$ROOT_DIR/$LEVEL/$dir"
              mkdir -p "$ROOT_DIR/$LEVEL"
              
              # ì´ë™ (ê¸°ì¡´ì— ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°/ë³‘í•©)
              if [ -d "$TARGET_DIR" ]; then
                echo "   - ê¸°ì¡´ í´ë” ë³‘í•© ì´ë™"
                cp -r "$dir"/* "$TARGET_DIR"/
                rm -rf "$dir"
              else
                echo "   - ìƒˆ í´ë”ë¡œ ì´ë™"
                mv "$dir" "$TARGET_DIR"
              fi
            fi
          done

      # 3. ë³€ê²½ ì‚¬í•­ ì €ì¥ ë° í‘¸ì‹œ
      - name: Commit and Push
        run: |
          git config --global user.name "hihi213"
          git config --global user.email "hihi213@users.noreply.github.com" 
          
          git add .
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„± (ìµœê·¼ ë©”ì‹œì§€ í™œìš©)
            ORIGINAL_MSG=$(git log -1 --pretty=%B)
            git commit -m "$ORIGINAL_MSG (Auto converted & organized)"
            git push origin main
          fi
