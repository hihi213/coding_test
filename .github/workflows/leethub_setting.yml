name: LeetHub Setting
on:
  push:
    branches: [ "main" ]
permissions:
  contents: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_leethub.outputs.should_run }}
      package_name: ${{ steps.detect_package.outputs.PACKAGE_NAME }}
      commit_msg: ${{ steps.check_leethub.outputs.commit_msg }}
      level: ${{ steps.extract_level.outputs.leetcode_level }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check if LeetHub Commit
        id: check_leethub
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | tail -n 1)
          echo "Latest commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" == Time:* && "$COMMIT_MSG" == *"- LeetHub" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
            echo "LeetHub ì»¤ë°‹ í™•ì¸, íŒ¨í‚¤ì§€ ì´ì‚¬ ì‘ì—… ì¤€ë¹„ âœ…"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "commit_msg=" >> $GITHUB_OUTPUT
            echo "ì‘ì—… ì—†ì´ íŒ¨ìŠ¤í•˜ë©´ ë©ë‹ˆë‹¤ âŒ"
          fi

      - name: Detect New Solve Package
        id: detect_package
        if: steps.check_leethub.outputs.should_run == 'true'
        run: |
          git config --global core.quotepath false
          EXCLUDE_DIRS=("LeetCode" "ë°±ì¤€" "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤" ".github")
          NEW_DIRS=$(git diff --name-only HEAD~1 HEAD | awk -F/ 'NF>=2 {print $1}' | sort -u)
          
          SAVEIFS=$IFS
          IFS=$'\n'
          FOUND=false
          for DIR in $NEW_DIRS; do
            SKIP=false
            for EX in "${EXCLUDE_DIRS[@]}"; do
              if [[ "$DIR" == "$EX" ]]; then
                SKIP=true
                break
              fi
            done
            if [[ "$SKIP" == false ]]; then
              echo "ìƒˆë¡œ ì¶”ê°€ëœ ë¬¸ì œí’€ì´ íŒ¨í‚¤ì§€ëª…: $DIR"
              echo "PACKAGE_NAME=$DIR" >> $GITHUB_OUTPUT
              FOUND=true
              break
            fi
          done
          IFS=$SAVEIFS
          
          if [[ "$FOUND" == false ]]; then
             echo "ìƒˆë¡œìš´ ë¬¸ì œ íŒ¨í‚¤ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Extract Level from README
        id: extract_level
        if: steps.check_leethub.outputs.should_run == 'true' && steps.detect_package.outputs.PACKAGE_NAME != ''
        run: |
          PACKAGE_NAME="${{ steps.detect_package.outputs.PACKAGE_NAME }}"
          README_PATH="$PACKAGE_NAME/README.md"
          if [ ! -f "$README_PATH" ]; then
            echo "README.md íŒŒì¼ ì—†ìŒ âŒ"
            echo "leetcode_level=Unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          LEVEL=$(grep -oP '(?<=<h3>).*?(?=</h3>)' "$README_PATH" | head -n 1)
          if [ -z "$LEVEL" ]; then
            LEVEL="Unknown"
          fi
          echo "LeetCode ë¬¸ì œ ë‚œì´ë„: $LEVEL"
          echo "leetcode_level=$LEVEL" >> $GITHUB_OUTPUT

  move:
    needs: detect
    if: ${{ needs.detect.outputs.should_run == 'true' && needs.detect.outputs.package_name != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Convert Code to MD and Move
        run: |
          PACKAGE_NAME="${{ needs.detect.outputs.package_name }}"
          LEVEL_DIRECTORY="${{ needs.detect.outputs.level }}"
          ROOT_DIR="LeetCode"
          
          echo "--------------------------------------------------"
          echo "ğŸ› ï¸ ì†ŒìŠ¤ ì½”ë“œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì‘ì—… ì‹œì‘"
          
          # íŒ¨í‚¤ì§€ ë‚´ë¶€ë¡œ ì´ë™í•´ì„œ íŒŒì¼ ìˆœíšŒ
          cd "$PACKAGE_NAME"
          
          for file in *; do
            # ë””ë ‰í† ë¦¬ê±°ë‚˜ ì´ë¯¸ md íŒŒì¼ì´ë©´ ê±´ë„ˆëœ€
            if [ -d "$file" ] || [[ "$file" == *.md ]]; then
              continue
            fi

            # í™•ì¥ì ì¶”ì¶œ ë° ì–¸ì–´ ë§¤í•‘
            EXT="${file##*.}"
            LANG=""
            
            case "$EXT" in
              py) LANG="python" ;;
              java) LANG="java" ;;
              cpp|cc|cxx) LANG="cpp" ;;
              js|ts) LANG="javascript" ;;
              go) LANG="go" ;;
              c) LANG="c" ;;
              kt|kotlin) LANG="kotlin" ;;
              swift) LANG="swift" ;;
              rb) LANG="ruby" ;;
              rs) LANG="rust" ;;
              sql) LANG="sql" ;;
            esac

            # ì§€ì›í•˜ëŠ” ì–¸ì–´ë¼ë©´ ë³€í™˜ ì‹¤í–‰
            if [ -n "$LANG" ]; then
              NEW_FILE="${file%.*}.md"
              echo "ğŸ“„ ë³€í™˜ ì¤‘: $file -> $NEW_FILE ($LANG)"
              
              # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ìƒì„± (í—¤ë” + ì½”ë“œë¸”ëŸ­)
              echo "### ì†ŒìŠ¤ ì½”ë“œ ($file)" > "$NEW_FILE"
              echo "" >> "$NEW_FILE"
              echo "\`\`\`$LANG" >> "$NEW_FILE"
              cat "$file" >> "$NEW_FILE"
              echo "" >> "$NEW_FILE" # íŒŒì¼ ëì— ì¤„ë°”ê¿ˆ í™•ë³´
              echo "\`\`\`" >> "$NEW_FILE"
              
              # ì›ë³¸ ì†ŒìŠ¤ ì½”ë“œ íŒŒì¼ ì‚­ì œ
              rm "$file"
            fi
          done
          
          # ë‹¤ì‹œ ìƒìœ„ í´ë”ë¡œ ë³µê·€
          cd ..
          echo "âœ… ë³€í™˜ ì™„ë£Œ"
          echo "--------------------------------------------------"

          # ---------------- ì´ì‚¬ ë¡œì§ ì‹œì‘ ----------------
          echo "ì˜®ê²¨ì•¼ í•  íŒ¨í‚¤ì§€ í™•ì¸: $PACKAGE_NAME"
          echo "ê°ì§€ëœ ë ˆë²¨: $LEVEL_DIRECTORY"
          
          FOUND_EXISTING_PATH=""
          for dir in "$ROOT_DIR"/*; do
            if [ -d "$dir/$PACKAGE_NAME" ]; then
              FOUND_EXISTING_PATH="$dir"
              break
            fi
          done
          
          if [ -n "$FOUND_EXISTING_PATH" ]; then
            DEST="$FOUND_EXISTING_PATH/$PACKAGE_NAME"
            echo "â†’ ê¸°ì¡´ ë””ë ‰í† ë¦¬ë¡œ ë³‘í•© ì´ë™: $DEST"
            cp -r "$PACKAGE_NAME"/* "$DEST"/
            rm -rf "$PACKAGE_NAME"
          else 
            DEST="$ROOT_DIR/$LEVEL_DIRECTORY/$PACKAGE_NAME"
            echo "â†’ ìƒˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™: $DEST"
            mkdir -p "$ROOT_DIR/$LEVEL_DIRECTORY"
            mv "$PACKAGE_NAME" "$ROOT_DIR/$LEVEL_DIRECTORY/"
          fi

      - name: Commit and Push
        run: |
          COMMIT_MSG="${{ needs.detect.outputs.commit_msg }}"
          echo "ì»¤ë°‹ ë©”ì„¸ì§€ í™•ì¸: $COMMIT_MSG"
          
          git config --global user.name "hihi213"
          git config --global user.email "hihi213@users.noreply.github.com" 
          
          git add .

          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "$COMMIT_MSG (Converted to MD)"
            git push origin main
          fi
